<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Grandmaster Analysis Hub - Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        :root {
            --bg-body: #161512; --bg-panel: #262421;
            --sq-light: #ebecd0; --sq-dark: #779556;
            --hl-move: rgba(0, 0, 0, 0.15); --hl-select: rgba(235, 236, 104, 0.7);
            --accent: #95bb4a; --board-size: min(85vh, 600px);
        }

        body {
            background-color: var(--bg-body); color: #bababa; margin: 0;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        .app-container { display: flex; gap: 30px; align-items: flex-start; }

        .board-container { position: relative; box-shadow: 0 15px 50px rgba(0,0,0,0.8); }
        .board {
            width: var(--board-size); height: var(--board-size);
            display: grid; grid-template-columns: repeat(8, 1fr);
        }

        .square {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .square.light { background: var(--sq-light); }
        .square.dark { background: var(--sq-dark); }
        .square.selected { background: var(--hl-select) !important; }
        
        .move-hint::after {
            content: ""; width: 26%; height: 26%; background: var(--hl-move); border-radius: 50%;
        }

        .piece {
            width: 100%; height: 100%; background-size: 90%;
            background-repeat: no-repeat; background-position: center; z-index: 10;
        }

        /* ÌîÑÎ°úÎ™®ÏÖò Î™®Îã¨ */
        .promotion-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100; display: flex;
            justify-content: center; align-items: center; backdrop-filter: blur(2px);
        }
        .promotion-modal.hidden { display: none; }
        .promo-choices {
            background: var(--bg-panel); padding: 15px; border-radius: 12px;
            display: flex; gap: 15px; border: 2px solid var(--accent);
        }
        .promo-option {
            width: 70px; height: 70px; background-size: contain;
            background-repeat: no-repeat; background-position: center;
            cursor: pointer; transition: transform 0.1s; border-radius: 8px;
            background-color: rgba(255,255,255,0.05);
        }
        .promo-option:hover { transform: scale(1.1); background-color: var(--accent); }

        /* ÏÇ¨Ïù¥ÎìúÎ∞î */
        .sidebar {
            width: 320px; background: var(--bg-panel); border-radius: 12px;
            padding: 25px; display: flex; flex-direction: column; gap: 20px;
            border: 1px solid #333;
        }
        .eval-section { border-bottom: 1px solid #333; padding-bottom: 20px; }
        .eval-num { font-size: 2.4rem; font-weight: 800; color: #fff; }
        .eval-bar { height: 8px; background: #444; border-radius: 4px; overflow: hidden; margin: 10px 0; }
        #eval-fill { height: 100%; width: 50%; background: #fff; transition: 0.6s ease; }
        .best-move { color: var(--accent); font-weight: 600; font-size: 1.1rem; }
        .history { 
            background: #1c1a17; height: 150px; padding: 12px; border-radius: 6px;
            overflow-y: auto; font-family: monospace; font-size: 0.85rem; line-height: 1.6;
        }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button {
            background: #3c3934; color: #fff; border: none; padding: 12px;
            border-radius: 6px; cursor: pointer; font-weight: bold;
        }
        button.primary { background: var(--accent); color: #161512; }
        .status-msg { font-size: 0.8rem; letter-spacing: 1px; color: #888; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="board-container">
        <div id="board" class="board"></div>
        <div id="promotion-modal" class="promotion-modal hidden">
            <div class="promo-choices" id="promo-choices"></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="eval-section">
            <div class="status-msg" id="game-status">White to move</div>
            <div class="eval-num" id="eval-val">0.0</div>
            <div class="eval-bar"><div id="eval-fill"></div></div>
            <div id="best-move" class="best-move">Engine Ready</div>
        </div>
        <div style="font-size: 0.75rem; color: #666;">MOVE HISTORY</div>
        <div id="history" class="history"></div>
        <div class="controls">
            <button onclick="app.undo()">‚Üê UNDO</button>
            <button class="primary" onclick="app.restart()">RESTART</button>
        </div>
    </div>
</div>

<script>
const PIECE_IMAGES = {
    wP: 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
    wR: 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
    wN: 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
    wB: 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
    wQ: 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
    wK: 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
    bP: 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
    bR: 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
    bN: 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
    bB: 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
    bQ: 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
    bK: 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
};

class ChessApp {
    constructor() {
        this.game = new Chess();
        this.selectedSquare = null;
        this.legalMoves = [];
        this.pendingPromotion = null;
        this.initEngine();
        this.render();
    }

    // üöÄ ÏàòÏ†ïÎêú ÏóîÏßÑ Î°úÎìú Î∂ÄÎ∂Ñ (GitHub Pages ÏµúÏ†ÅÌôî)
    initEngine() {
        try {
            // Î≥¥Ïïà Ï†ïÏ±ÖÏóê Í∞ÄÏû• Ïú†Ïó∞Ìïú Íµ¨Î≤ÑÏ†Ñ ÏóîÏßÑ Ï£ºÏÜåÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§.
            const engineUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js';
            this.sf = new Worker(engineUrl);
            
            this.sf.onmessage = (e) => this.handleEngine(e.data);
            this.sf.postMessage('uci');
            this.analyze();
        } catch(e) { 
            console.error("Engine failure.");
            document.getElementById('best-move').innerText = "Engine Load Error";
        }
    }

    render() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        const board = this.game.board();

        for (let r = 0; r < 8; r++) {
            for (let c = 0; c < 8; c++) {
                const sqName = String.fromCharCode(97 + c) + (8 - r);
                const sq = document.createElement('div');
                sq.className = `square ${(r + c) % 2 === 0 ? 'light' : 'dark'}`;
                if (this.selectedSquare === sqName) sq.classList.add('selected');
                if (this.legalMoves.includes(sqName)) sq.classList.add('move-hint');
                sq.onclick = () => this.onSquareClick(sqName);

                const p = board[r][c];
                if (p) {
                    const pEl = document.createElement('div');
                    pEl.className = 'piece';
                    pEl.style.backgroundImage = `url(${PIECE_IMAGES[p.color + p.type.toUpperCase()]})`;
                    sq.appendChild(pEl);
                }
                boardEl.appendChild(sq);
            }
        }
    }

    onSquareClick(square) {
        if (this.pendingPromotion) return;
        if (this.selectedSquare && this.legalMoves.includes(square)) {
            const from = this.selectedSquare;
            const piece = this.game.get(from);
            const isPromotion = piece.type === 'p' && (square[1] === '8' || square[1] === '1');

            if (isPromotion) {
                this.pendingPromotion = { from, to: square };
                this.showPromotionModal(piece.color);
            } else {
                this.game.move({ from, to: square });
                this.onMoveComplete();
            }
            return;
        }
        const piece = this.game.get(square);
        if (piece && piece.color === this.game.turn()) {
            this.selectedSquare = square;
            this.legalMoves = this.game.moves({ square: square, verbose: true }).map(m => m.to);
        } else {
            this.selectedSquare = null; this.legalMoves = [];
        }
        this.render();
    }

    showPromotionModal(color) {
        const modal = document.getElementById('promotion-modal');
        const choicesEl = document.getElementById('promo-choices');
        choicesEl.innerHTML = '';
        ['q', 'r', 'b', 'n'].forEach(type => {
            const option = document.createElement('div');
            option.className = 'promo-option';
            option.style.backgroundImage = `url(${PIECE_IMAGES[color + type.toUpperCase()]})`;
            option.onclick = () => this.finishPromotion(type);
            choicesEl.appendChild(option);
        });
        modal.classList.remove('hidden');
    }

    finishPromotion(pieceType) {
        this.game.move({ from: this.pendingPromotion.from, to: this.pendingPromotion.to, promotion: pieceType });
        document.getElementById('promotion-modal').classList.add('hidden');
        this.pendingPromotion = null;
        this.onMoveComplete();
    }

    onMoveComplete() {
        this.selectedSquare = null; this.legalMoves = [];
        this.render();
        this.updateUI();
        this.analyze();
    }

    undo() { this.game.undo(); this.onMoveComplete(); }
    restart() { if(confirm("Restart?")) { this.game.reset(); this.onMoveComplete(); } }

    updateUI() {
        const history = this.game.history();
        document.getElementById('history').innerText = history.join(' ');
        const status = document.getElementById('game-status');
        if (this.game.in_checkmate()) status.innerText = "Checkmate!";
        else status.innerText = (this.game.turn() === 'w' ? "White" : "Black") + " to move";
    }

    analyze() {
        if (this.sf) {
            this.sf.postMessage(`position fen ${this.game.fen()}`);
            this.sf.postMessage('go depth 12');
        }
    }

    handleEngine(msg) {
        if (msg.includes('cp ')) {
            let cp = parseInt(msg.match(/cp (-?\d+)/)[1]) / 100;
            if (this.game.turn() === 'b') cp = -cp;
            document.getElementById('eval-val').innerText = (cp > 0 ? "+" : "") + cp.toFixed(1);
            document.getElementById('eval-fill').style.width = Math.max(0, Math.min(100, 50 + cp * 10)) + "%";
        } else if (msg.startsWith('bestmove')) {
            document.getElementById('best-move').innerText = "Best: " + msg.split(' ')[1];
        }
    }
}
const app = new ChessApp();
</script>
</body>
</html>